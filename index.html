<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>YNAB</title>
<link rel="stylesheet" href="finance-logger.css">
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="wordmark">YNA<em>B</em></div>
    <div class="gear-btn" onclick="openSettings()">âš™</div>
  </div>

  <div class="mode-strip">
    <div class="pills">
      <div class="pill active" data-mode="expense"  onclick="selectMode('expense')">Expense</div>
      <div class="pill"        data-mode="income"   onclick="selectMode('income')">Income</div>
      <div class="pill"        data-mode="transfer" onclick="selectMode('transfer')">Transfer</div>
      <div class="pill"        data-mode="manual"   onclick="selectMode('manual')">Manual</div>
    </div>
  </div>

  <div class="content">

    <!-- UPLOAD -->
    <div class="screen active" id="screen-upload">
      <div class="upload-hero" id="upload-hero" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon" id="upload-icon">ðŸ“·</div>
        <div class="upload-label" id="upload-label">Share a screenshot</div>
        <div class="upload-sub"   id="upload-sub">GCash, credit card, any bank app</div>
      </div>
      <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
    </div>

    <!-- PARSING -->
    <div class="screen" id="screen-parsing">
      <div class="parsing-screen">
        <div class="pulse-ring"><div class="pulse-dot"></div></div>
        <div class="parsing-text">Reading screenshotâ€¦</div>
      </div>
    </div>

    <!-- CONFIRM -->
    <div class="screen" id="screen-confirm">
      <div class="receipt" id="receipt-card">
        <div class="receipt-hero" id="receipt-hero">
          <div class="hero-amount-wrap">
            <div class="receipt-amount" id="r-amount" onclick="editAmount()">â‚±0.00</div>
            <div class="type-chip" id="r-type-chip">expense</div>
          </div>
          <div class="receipt-meta">
            <div class="receipt-merchant-wrap">
              <div class="receipt-merchant" id="r-merchant" onclick="editMerchant()">â€”</div>
            </div>
            <div class="receipt-date" id="r-date" onclick="editDate()">â€”</div>
          </div>
        </div>
        <div id="warn-banner-wrap"></div>
        <div class="field-section" id="r-fields"></div>
      </div>
      <div id="dupe-warn-wrap"></div>
      <div id="transfer-notice" class="transfer-notice" style="display:none">â†• Logs 2 rows â€” outgoing and incoming.</div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Retake</div>
        <div class="btn btn-log"   id="btn-log-it" onclick="handleLogIt()">Log It</div>
      </div>
    </div>

    <!-- FAILURE -->
    <div class="screen" id="screen-failure">
      <div class="failure-card">
        <div class="failure-title">Failed to log</div>
        <div class="failure-desc">Transaction didn't reach your Sheet. Your data is safe â€” retry or copy it to paste manually.</div>
        <div class="failure-actions">
          <button class="btn-retry" onclick="retryLog()">Retry</button>
          <button class="btn-copy"  onclick="copyFailed()">Copy row</button>
        </div>
      </div>
      <div class="btn btn-ghost" onclick="cancelConfirm()">Start over</div>
    </div>

    <!-- SUCCESS -->
    <div class="screen" id="screen-success">
      <div class="success-card">
        <div class="success-check">âœ“</div>
        <div class="success-label" id="success-label">Logged</div>
        <div class="success-detail" id="success-detail"></div>
      </div>
    </div>

    <!-- MANUAL -->
    <div class="screen" id="screen-manual">
      <div class="form-block" id="manual-form"></div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Cancel</div>
        <div class="btn btn-log"   onclick="submitManual()">Log It</div>
      </div>
    </div>

  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="overlay" onclick="closeSettings(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Settings</div>
    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input class="setting-input" type="password" id="s-gemini" placeholder="AIzaâ€¦" oninput="saveSetting('gemini',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google Sheet ID</div>
      <input class="setting-input" type="text" id="s-sheetid" placeholder="Sheet ID from URL" oninput="saveSetting('sheetId',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google API Key</div>
      <input class="setting-input" type="password" id="s-googleapi" placeholder="AIzaâ€¦" oninput="saveSetting('googleApi',this.value)">
      <div class="setting-hint">Needs Sheets API enabled. Free at console.cloud.google.com.</div>
    </div>
    <div class="btn btn-log" onclick="closeSettings()">Done</div>
  </div>
</div>

<!-- GENERIC PICKER SHEET -->
<div class="sheet-overlay" id="picker-sheet" onclick="if(event.target===this)closePicker()">
  <div class="sheet-inner">
    <div class="sheet-drag"></div>
    <div class="sheet-list" id="picker-list"></div>
  </div>
</div>

<!-- CATEGORY PICKER SHEET -->
<div class="sheet-overlay" id="cat-sheet" onclick="if(event.target===this)closeCatPicker()">
  <div class="sheet-inner">
    <div class="sheet-drag"></div>
    <div class="sheet-search-wrap">
      <input id="cat-search" type="text" class="sheet-search" placeholder="Searchâ€¦" autocomplete="off" oninput="filterCats(this.value)">
    </div>
    <div class="sheet-list" id="cat-list"></div>
  </div>
</div>

<!-- NUMPAD -->
<div class="numpad-overlay" id="numpad-overlay" style="display:none" onclick="numpadOutside(event)">
  <div class="numpad" id="numpad">
    <div class="numpad-display">
      <div class="numpad-expr" id="np-expr">0</div>
      <div class="numpad-result" id="np-result"></div>
    </div>
    <div class="numpad-grid">
      <button class="nk nk-num" onclick="npInput('7')">7</button>
      <button class="nk nk-num" onclick="npInput('8')">8</button>
      <button class="nk nk-num" onclick="npInput('9')">9</button>
      <button class="nk nk-op"  onclick="npInput('Ã·')">Ã·</button>

      <button class="nk nk-num" onclick="npInput('4')">4</button>
      <button class="nk nk-num" onclick="npInput('5')">5</button>
      <button class="nk nk-num" onclick="npInput('6')">6</button>
      <button class="nk nk-op"  onclick="npInput('Ã—')">Ã—</button>

      <button class="nk nk-num" onclick="npInput('1')">1</button>
      <button class="nk nk-num" onclick="npInput('2')">2</button>
      <button class="nk nk-num" onclick="npInput('3')">3</button>
      <button class="nk nk-op"  onclick="npInput('-')">âˆ’</button>

      <button class="nk nk-num nk-zero" onclick="npInput('0')">0</button>
      <button class="nk nk-num"         onclick="npInput('.')">.</button>
      <button class="nk nk-op"          onclick="npInput('+')">+</button>

      <button class="nk nk-del" style="grid-column:span 3" onclick="npDelete()">âŒ« delete</button>
      <button class="nk nk-done" onclick="npDone()">Done</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const SHEET_TAB        = 'Log';
const WEBHOOK          = 'https://script.google.com/macros/s/AKfycbwfl8-4sVKehGHxjGJirXVOYoTOZyinPFijxhQxJVVZQbWFaeBv53hr5HHuoPzYCg5z-Q/exec';
const SHEET_ID_DEFAULT = '15G5abgmSIE-kYkh0LI3FtWXPO2DlvVgUnWmAcn36nE0';

// Gemini: supported image MIME types
const SUPPORTED_MIME = ['image/jpeg','image/png','image/webp','image/gif'];

// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CATEGORY_MAP = {
  'Salary':'Income','IOU':'Income',
  'Electricity':'Home','Groceries':'Home','Lulay':'Home',
  'Pet Food':'Pets','Grooming':'Pets','Litter':'Pets','Misc':'Pets','Vet':'Pets',
  'Doctor':'Health','Supplements':'Health','Therapy':'Health','Medicine':'Health','Lab Tests':'Health','Eyes':'Health',
  'Cellphone':'Quality Of Life','Eating Out':'Quality Of Life','Car':'Quality Of Life','Self Care':'Quality Of Life',
  'Social':'Quality Of Life','Shopping':'Quality Of Life','Transpo':'Quality Of Life','Others':'Quality Of Life',
  'Stellar Rebels':'Stellar Rebels',
  'Digital Subscriptions':'Sinking','Gifts':'Sinking','Car Maintenance':'Sinking','Home Maintenance':'Sinking',
  'Family Emergency':'Emergency','Medical Emergency':'Emergency','Pet Emergency':'Emergency','Job Loss':'Emergency',
  'Tech Fund':'Goals','Beauty Fund':'Goals','Vacation Fund':'Goals',
};

const INCOME_CATS     = ['Salary','IOU'];
const EXPENSE_CATS    = Object.keys(CATEGORY_MAP).filter(c => !INCOME_CATS.includes(c));
const PAYMENT_METHODS = ['GCash','Maribank','BDO','BPI','Maya','UnionBank','UnionBank Credit','Cash'];
const REVIEW_OPTIONS  = ['Myself','Others','Both'];

const MERCHANT_RULES = [
  { keywords: ['grab'],                     paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['indrive','in drive'],       paymentMethod: 'Cash',             category: null },
  { keywords: ['shopee'],                   paymentMethod: 'Maribank',         category: null },
  { keywords: ['lazada'],                   paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['app store','apple'],        paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['google play','play store'], paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['netflix'],                  paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['spotify'],                  paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['youtube premium'],          paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['canva'],                    paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['adobe'],                    paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentMode    = localStorage.getItem('lastMode') || 'expense';
let parsedData     = {};
let lastFailedRows = null;
let lastLoggedKey  = null;
let lastLoggedTime = 0;
let activeDropdown = null;
let pendingRows    = null;

// Numpad state
let npTarget = null;
let npExpr   = '0';

// Generic picker state
let _pickerTarget  = null;
let _pickerOptions = [];
let _pickerCb      = null;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

localStorage.getItem('sheetId') || localStorage.setItem('sheetId', SHEET_ID_DEFAULT);

function loadSettings() {
  document.getElementById('s-gemini').value    = localStorage.getItem('gemini')    || '';
  document.getElementById('s-sheetid').value   = localStorage.getItem('sheetId')   || '';
  document.getElementById('s-googleapi').value = localStorage.getItem('googleApi') || '';
}
function saveSetting(k, v) { localStorage.setItem(k, v); }
function openSettings()    { loadSettings(); document.getElementById('overlay').classList.add('open'); }
function closeSettings(e)  { if (!e || e.target === document.getElementById('overlay')) document.getElementById('overlay').classList.remove('open'); }

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function haptic(style = 'light') {
  if (navigator.vibrate) {
    const map = { light: 30, medium: 60, success: [30,50,30], error: [60,30,60] };
    navigator.vibrate(map[style] || 30);
  }
}

function fmt(n) {
  return 'â‚±' + Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function toSheetDate(isoOrRaw) {
  const d = new Date(isoOrRaw + 'T00:00:00');
  if (isNaN(d)) return isoOrRaw;
  return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
}

function todayISO() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function displayDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  if (isNaN(d)) return iso;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function applyMerchantRules(merchant) {
  if (!merchant) return {};
  const lower = merchant.toLowerCase();
  for (const rule of MERCHANT_RULES) {
    if (rule.keywords.some(k => lower.includes(k))) {
      return { paymentMethod: rule.paymentMethod, category: rule.category };
    }
  }
  return {};
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  closeAllDropdowns();
}

function cancelConfirm() {
  parsedData = {}; lastFailedRows = null; pendingRows = null;
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  if (currentMode === 'transfer' || currentMode === 'manual') {
    buildManualForm(currentMode);
    show('screen-manual');
  } else {
    refreshHero();
    show('screen-upload');
  }
}

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectMode(mode) {
  currentMode = mode;
  localStorage.setItem('lastMode', mode);
  document.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p.dataset.mode === mode));
  if (mode === 'transfer' || mode === 'manual') { buildManualForm(mode); show('screen-manual'); }
  else { refreshHero(); show('screen-upload'); }
}

function refreshHero() {
  const map = {
    expense: { icon: 'ðŸ“·', label: 'Share a screenshot', sub: 'GCash, credit card, any bank app' },
    income:  { icon: 'ðŸ“¥', label: 'Share a screenshot', sub: 'Salary slip, GCash, any inflow' },
  };
  const d = map[currentMode] || map.expense;
  document.getElementById('upload-icon').textContent  = d.icon;
  document.getElementById('upload-label').textContent = d.label;
  document.getElementById('upload-sub').textContent   = d.sub;
}

// â”€â”€ FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleFile(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = () => parseWithGemini(reader.result);
  reader.readAsDataURL(file);
}

// â”€â”€ GEMINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function parseWithGemini(dataUrl) {
  const rawKey = localStorage.getItem('gemini') || '';
  const apiKey = rawKey.trim().replace(/[^A-Za-z0-9_\-]/g, '');
  if (!apiKey || apiKey.length < 20) {
    alert('Gemini API key is missing or invalid. Check Settings.');
    return;
  }

  // FIX: reject unsupported image formats before sending to Gemini
  const mimeType = dataUrl.split(';')[0].split(':')[1];
  if (!SUPPORTED_MIME.includes(mimeType)) {
    alert('Unsupported image format. Please use a JPEG, PNG, or WebP screenshot.');
    show('screen-upload');
    return;
  }

  show('screen-parsing');

  const cats  = currentMode === 'income' ? INCOME_CATS.join(', ') : EXPENSE_CATS.join(', ');
  const today = todayISO();

  // FIX: prompt now lists UnionBank Credit instead of the removed Credit Card option
  const prompt = `Extract transaction data from this Filipino payment app screenshot.
Return ONLY valid JSON â€” no markdown, no explanation:
{"amount":number,"date":"YYYY-MM-DD","merchant":"string","payment_method":"one of: GCash, UnionBank Credit, Maribank, BDO, BPI, Maya, UnionBank, Cash","category":"one of: ${cats}","low_confidence":boolean}

Rules:
- amount is always positive
- Default payment_method to GCash if unclear
- Pick the closest category from the provided list only
- If date is unclear use ${today}
- Set low_confidence to true if you are unsure about any field
- If screenshot has no recognizable transaction, return {"error":"no_transaction"}`;

  const base64 = dataUrl.split(',')[1];

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64 } }] }],
        // FIX: raised from 400 to 1024 to prevent truncation on verbose responses
        generationConfig: { maxOutputTokens: 1024, temperature: 0.1 }
      })
    });

    const data = await res.json();

    // FIX: surface specific errors before attempting JSON.parse
    if (res.status === 429) {
      alert('Gemini daily limit reached (20 requests/day on free tier). Resets at midnight UTC.');
      show('screen-upload');
      return;
    }

    if (!res.ok) {
      console.error('Gemini error:', JSON.stringify(data));
      throw new Error(`Gemini ${res.status}: ${data?.error?.message || 'unknown'}`);
    }

    const raw    = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = JSON.parse(raw.replace(/```json|```/g, '').trim());

    if (parsed.error === 'no_transaction') {
      alert('No transaction found in this screenshot. Try a different image or use Manual.');
      show('screen-upload');
      return;
    }

    const rules       = applyMerchantRules(parsed.merchant);
    const paymentMethod = rules.paymentMethod || parsed.payment_method;
    const category      = rules.category      || parsed.category;

    parsedData = {
      type:          currentMode === 'income' ? 'Income' : 'Expense',
      amount:        parsed.amount,
      date:          parsed.date || today,
      merchant:      parsed.merchant,
      paymentMethod,
      category,
      group:         CATEGORY_MAP[category] || '',
      memo:          '',
      review:        'Myself',
      lowConfidence: parsed.low_confidence || false,
      autoPayment:   !!rules.paymentMethod,
      autoCategory:  !!rules.category,
    };

    buildReceiptCard();
    show('screen-confirm');
    haptic('light');

  } catch(err) {
    console.error(err);
    alert('Could not parse screenshot. Try again or use Manual.');
    show('screen-upload');
  }
}

// â”€â”€ RECEIPT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildReceiptCard() {
  const d = parsedData;

  const amtEl = document.getElementById('r-amount');
  amtEl.textContent = fmt(d.amount);
  amtEl.className   = `receipt-amount ${d.type.toLowerCase()}`;

  const hero = document.getElementById('receipt-hero');
  hero.className = `receipt-hero ${d.type.toLowerCase()}-bg`;

  const chip = document.getElementById('r-type-chip');
  chip.textContent = d.type.toLowerCase();
  chip.className   = `type-chip ${d.type.toLowerCase()}`;

  document.getElementById('r-merchant').textContent = d.merchant || 'â€”';
  document.getElementById('r-date').textContent     = displayDate(d.date);

  const warnWrap = document.getElementById('warn-banner-wrap');
  warnWrap.innerHTML = d.lowConfidence
    ? `<div class="warn-banner" style="border-radius:0;border-left:none;border-right:none;border-top:none;">âš  Low confidence â€” review fields carefully</div>`
    : '';

  const cats   = d.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  const fields = [
    { key: 'Via',      dataKey: 'paymentMethod', type: 'select',   options: PAYMENT_METHODS, auto: d.autoPayment },
    { key: 'Category', dataKey: 'category',      type: 'dropdown', options: cats,             auto: d.autoCategory },
    { key: 'Group',    dataKey: 'group',          type: 'badge' },
    { key: 'Memo',     dataKey: 'memo',           type: 'text' },
    { key: 'Review',   dataKey: 'review',         type: 'select',   options: REVIEW_OPTIONS },
  ];

  const container = document.getElementById('r-fields');
  container.innerHTML = '';

  fields.forEach(f => {
    const row = document.createElement('div');
    row.className   = 'field-row';
    row.dataset.key = f.dataKey;

    if (f.type === 'badge') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="field-val group-tag"><span class="group-badge" id="badge-group">${d[f.dataKey] || 'â€”'}</span></div>`;

    } else if (f.type === 'text') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;flex:1">
          <input class="inline-input" id="field-memo" maxlength="60" value="${d[f.dataKey] || ''}" placeholder="Optional"
            oninput="updateField('${f.dataKey}',this.value);updateCharCount(this)"
            onfocus="updateCharCount(this)">
          <div class="char-count" id="memo-count" style="display:none"></div>
        </div>`;

    } else if (f.type === 'dropdown') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="dropdown-wrap" id="dd-wrap-${f.dataKey}">
          <input class="dropdown-input" id="dd-${f.dataKey}" value="${d[f.dataKey] || ''}" placeholder="Tap to searchâ€¦"
            autocomplete="off"
            onfocus="openDropdown('${f.dataKey}')"
            oninput="filterDropdown('${f.dataKey}', this.value)"
            onkeydown="dropdownKeyNav(event,'${f.dataKey}')"
            onblur="setTimeout(()=>closeAllDropdowns(),200)">
          ${autoBadge}
          <div class="dropdown-list" id="ddlist-${f.dataKey}" style="display:none"></div>
        </div>`;

    } else if (f.type === 'select') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      const opts = f.options.map(o => `<option ${d[f.dataKey] === o ? 'selected' : ''}>${o}</option>`).join('');
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;flex:1">
          ${autoBadge}
          <select class="inline-select" style="width:auto" onchange="updateField('${f.dataKey}',this.value)">${opts}</select>
        </div>`;
    }

    container.appendChild(row);
  });

  if (document.getElementById('ddlist-category')) {
    renderDropdownList('category', cats, d.category);
  }
}

// â”€â”€ HERO INLINE EDITING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function editAmount() {
  const el  = document.getElementById('r-amount');
  const raw = parsedData.amount || 0;
  el.outerHTML = `<input class="receipt-amount-input ${parsedData.type.toLowerCase()}" id="r-amount-input"
    type="text" inputmode="decimal" value="${raw}"
    onblur="commitAmount(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()">`;
  setTimeout(() => { const inp = document.getElementById('r-amount-input'); if (inp) { inp.focus(); inp.select(); } }, 50);
}

function commitAmount(val) {
  const num  = parseFloat(val.replace(/,/g, '')) || 0;
  parsedData.amount = num;
  const wrap = document.getElementById('r-amount-input') || document.querySelector('.receipt-amount-input');
  if (wrap) {
    const div = document.createElement('div');
    div.className = `receipt-amount ${parsedData.type.toLowerCase()}`;
    div.id = 'r-amount';
    div.textContent = fmt(num);
    div.onclick = editAmount;
    wrap.replaceWith(div);
  }
}

function editMerchant() {
  const el = document.getElementById('r-merchant');
  el.outerHTML = `<input class="merchant-input" id="merchant-input" value="${parsedData.merchant || ''}"
    onblur="commitMerchant(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()">`;
  setTimeout(() => { const inp = document.getElementById('merchant-input'); if (inp) { inp.focus(); inp.select(); } }, 50);
}

function commitMerchant(val) {
  parsedData.merchant = val;
  const inp = document.getElementById('merchant-input');
  if (inp) {
    const div = document.createElement('div');
    div.className = 'receipt-merchant';
    div.id = 'r-merchant';
    div.textContent = val || 'â€”';
    div.onclick = editMerchant;
    inp.replaceWith(div);
  }
  const rules = applyMerchantRules(val);
  if (rules.paymentMethod) {
    parsedData.paymentMethod = rules.paymentMethod;
    parsedData.autoPayment   = true;
    const sel = document.querySelector('[data-key="paymentMethod"] select');
    if (sel) sel.value = rules.paymentMethod;
  }
}

function editDate() {
  const el = document.getElementById('r-date');
  el.outerHTML = `<input class="date-input" id="date-input" type="date" value="${parsedData.date || todayISO()}"
    onblur="commitDate(this.value)"
    onchange="commitDate(this.value)">`;
  setTimeout(() => { const inp = document.getElementById('date-input'); if (inp) inp.focus(); }, 50);
}

function commitDate(val) {
  parsedData.date = val;
  const inp = document.getElementById('date-input');
  if (inp) {
    const div = document.createElement('div');
    div.className = 'receipt-date';
    div.id = 'r-date';
    div.textContent = displayDate(val);
    div.onclick = editDate;
    inp.replaceWith(div);
  }
}

// â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDropdownList(key, options, selected, filter = '') {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list) return;
  const filtered = filter
    ? options.filter(o => o.toLowerCase().includes(filter.toLowerCase()))
    : options;

  if (!filtered.length) {
    list.innerHTML = `<div class="dropdown-empty">No match</div>`;
    list.style.display = 'block';
    return;
  }

  list.innerHTML = filtered.map((o, i) =>
    `<div class="dropdown-item ${o === selected ? 'selected' : ''}" data-idx="${i}" data-val="${o}"
      onmousedown="selectDropdownItem('${key}','${o}')" ontouchend="selectDropdownItem('${key}','${o}')">${o}</div>`
  ).join('');
  list.style.display = 'block';
}

function openDropdown(key) {
  const cats = parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  renderDropdownList(key, cats, parsedData[key] || '');
  activeDropdown = key;
}

function filterDropdown(key, val) {
  const cats = parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  renderDropdownList(key, cats, parsedData[key] || '', val);
}

function selectDropdownItem(key, val) {
  updateField(key, val);
  const inp = document.getElementById(`dd-${key}`);
  if (inp) { inp.value = val; inp.blur(); }
  const list = document.getElementById(`ddlist-${key}`);
  if (list) list.style.display = 'none';
  activeDropdown = null;
  haptic('light');
}

function dropdownKeyNav(e, key) {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list || list.style.display === 'none') return;
  const items   = list.querySelectorAll('.dropdown-item');
  const current = list.querySelector('.highlighted');
  let idx = current ? parseInt(current.dataset.idx) : -1;

  if (e.key === 'ArrowDown')                    { e.preventDefault(); idx = Math.min(idx+1, items.length-1); }
  else if (e.key === 'ArrowUp')                 { e.preventDefault(); idx = Math.max(idx-1, 0); }
  else if (e.key === 'Enter' && current)        { e.preventDefault(); selectDropdownItem(key, current.dataset.val); return; }
  else if (e.key === 'Escape')                  { list.style.display = 'none'; return; }

  items.forEach(it => it.classList.remove('highlighted'));
  if (items[idx]) items[idx].classList.add('highlighted');
}

function closeAllDropdowns() {
  document.querySelectorAll('.dropdown-list').forEach(l => l.style.display = 'none');
  activeDropdown = null;
}

document.addEventListener('click', e => {
  if (!e.target.closest('.dropdown-wrap')) closeAllDropdowns();
});

// â”€â”€ FIELD UPDATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateField(key, value) {
  parsedData[key] = value;
  if (key === 'category') {
    parsedData.group = CATEGORY_MAP[value] || '';
    const b = document.getElementById('badge-group');
    if (b) b.textContent = parsedData.group || 'â€”';
  }
}

function updateCharCount(inp) {
  const counter = document.getElementById('memo-count');
  if (!counter) return;
  const len = inp.value.length;
  counter.style.display = len > 0 ? 'block' : 'none';
  counter.textContent   = `${len}/60`;
  counter.style.color   = len > 50 ? 'var(--warn)' : 'var(--muted)';
}

// â”€â”€ LOG IT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleLogIt() {
  const amtInp = document.getElementById('r-amount-input');
  if (amtInp) commitAmount(amtInp.value);
  const mInp = document.getElementById('merchant-input');
  if (mInp) commitMerchant(mInp.value);
  const dInp = document.getElementById('date-input');
  if (dInp) commitDate(dInp.value);

  const d         = parsedData;
  const ts        = new Date().toISOString();
  const amt       = d.type === 'Income' ? Math.abs(d.amount) : -Math.abs(d.amount);
  const sheetDate = toSheetDate(d.date);
  const rows      = [[ts, d.type, amt, sheetDate, d.merchant, d.paymentMethod, d.category, d.group, d.memo, d.review]];

  const dupeKey = `${d.amount}|${d.merchant}`;
  const now     = Date.now();
  if (dupeKey === lastLoggedKey && now - lastLoggedTime < 60000) {
    showDupeWarning(rows, d);
    return;
  }

  haptic('medium');
  appendRows(rows, d);
}

function showDupeWarning(rows, d) {
  document.getElementById('dupe-warn-wrap').innerHTML = `
    <div class="dupe-card">
      <div class="dupe-title">âš  Possible duplicate</div>
      <div class="dupe-desc">Same amount and merchant logged less than a minute ago. Log again?</div>
      <div class="dupe-actions">
        <button class="btn-dupe-log"    onclick="confirmDupe()">Log anyway</button>
        <button class="btn-dupe-cancel" onclick="dismissDupe()">Cancel</button>
      </div>
    </div>`;
  pendingRows = { rows, d };
}

function confirmDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  if (pendingRows) { haptic('medium'); appendRows(pendingRows.rows, pendingRows.d); pendingRows = null; }
}

function dismissDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  pendingRows = null;
}

// â”€â”€ MANUAL FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildManualForm(mode) {
  const today      = todayISO();
  const lastMethod = localStorage.getItem('lastPaymentMethod') || PAYMENT_METHODS[0];
  const c          = document.getElementById('manual-form');

  const row = (key, ctrl) =>
    `<div class="form-row-inner"><div class="form-key">${key}</div><div class="form-val-wrap">${ctrl}</div></div>`;

  const text = (id, ph) =>
    `<input class="form-ctrl" id="${id}" type="text" placeholder="${ph}">`;

  const nativeSelect = (id, opts, selected, onch = '') =>
    `<select class="form-select-ctrl" id="${id}" ${onch}>${opts.map(o => `<option ${o === selected ? 'selected' : ''}>${o}</option>`).join('')}</select>`;

  const amtDisplay = () =>
    `<div class="form-picker" id="m-amount-display" onclick="openNumpad('m-amount')" style="color:var(--muted)">0.00</div><input type="hidden" id="m-amount" value="0">`;

  const catPicker = (firstCat) =>
    `<div class="form-picker" id="m-category-display" data-val="${firstCat}" onclick="openCategoryPicker()">${firstCat}<span class="picker-caret">â€º</span></div>`;

  if (mode === 'transfer') {
    c.innerHTML =
      row('Amount', amtDisplay()) +
      row('Date',   `<input class="form-ctrl" id="m-date" type="date" value="${today}" style="color-scheme:dark">`) +
      row('From',   nativeSelect('m-from', PAYMENT_METHODS, lastMethod, 'onchange="syncTransferTo()"')) +
      row('To',     nativeSelect('m-to', PAYMENT_METHODS.filter(p => p !== lastMethod), PAYMENT_METHODS.find(p => p !== lastMethod) || PAYMENT_METHODS[1])) +
      row('Memo',   text('m-memo', 'Optional'));
  } else {
    const firstCat = EXPENSE_CATS[0];
    c.innerHTML =
      row('Type',     nativeSelect('m-type', ['Expense','Income','Balance'], 'Expense', 'onchange="updateManualCats()"')) +
      row('Amount',   amtDisplay()) +
      row('Date',     `<input class="form-ctrl" id="m-date" type="date" value="${today}" style="color-scheme:dark">`) +
      row('Merchant', `<input class="form-ctrl" id="m-merchant" type="text" placeholder="Who or where" oninput="applyManualMerchantRules(this.value)">`) +
      row('Via',      nativeSelect('m-payment', PAYMENT_METHODS, lastMethod)) +
      row('Category', catPicker(firstCat)) +
      row('Group',    `<div class="form-readonly-val" id="m-group">${CATEGORY_MAP[firstCat] || ''}</div>`) +
      row('Memo',     text('m-memo', 'Optional')) +
      row('Review',   `<div class="review-btns" id="review-btns">
        ${REVIEW_OPTIONS.map((o, i) => `<button type="button" class="review-btn${i === 0 ? ' active' : ''}" onclick="selectReview(this,'${o}')">${o}</button>`).join('')}
      </div>`);
  }
}

function selectReview(btn) {
  document.querySelectorAll('.review-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function getReviewVal() {
  const active = document.querySelector('.review-btn.active');
  return active ? active.textContent : 'Myself';
}

function evalExpr(str) {
  const cleaned = str.replace(/,/g, '').trim();
  if (!/^[0-9+\-*/.() ]+$/.test(cleaned)) return null;
  try {
    const result = Function('"use strict"; return (' + cleaned + ')')();
    return (typeof result === 'number' && isFinite(result)) ? Math.round(result * 100) / 100 : null;
  } catch { return null; }
}

function getRawAmt(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  return parseFloat(el.value) || 0;
}

function syncTransferTo() {
  const from  = document.getElementById('m-from')?.value;
  const toSel = document.getElementById('m-to');
  if (!toSel || !from) return;
  toSel.innerHTML = PAYMENT_METHODS.filter(p => p !== from).map(p => `<option>${p}</option>`).join('');
}

function applyManualMerchantRules(val) {
  const rules = applyMerchantRules(val);
  if (rules.paymentMethod) {
    const sel = document.getElementById('m-payment');
    if (sel) sel.value = rules.paymentMethod;
  }
  if (rules.category) {
    setPickerVal('m-category', rules.category);
    updateManualGroup();
  }
}

// FIX: reads m-type directly (was incorrectly reading m-type-display dataset)
function updateManualCats() {
  const type   = document.getElementById('m-type')?.value || 'Expense';
  const catRow = document.getElementById('m-category-display')?.closest('.form-row-inner');
  const grpRow = document.getElementById('m-group')?.closest('.form-row-inner');
  const revRow = document.getElementById('review-btns')?.closest('.form-row-inner');

  if (type === 'Balance') {
    if (catRow) catRow.style.display = 'none';
    if (grpRow) grpRow.style.display = 'none';
    if (revRow) revRow.style.display = 'none';
    return;
  }

  if (catRow) catRow.style.display = '';
  if (grpRow) grpRow.style.display = '';
  if (revRow) revRow.style.display = '';

  const cats    = type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  const catDisp = document.getElementById('m-category-display');
  if (catDisp) {
    catDisp.dataset.val = cats[0];
    const caret = catDisp.querySelector('.picker-caret');
    catDisp.textContent = cats[0];
    if (caret) catDisp.appendChild(caret);
  }
  updateManualGroup();
}

function updateManualGroup() {
  const cat = document.getElementById('m-category-display')?.dataset.val || '';
  const el  = document.getElementById('m-group');
  if (el && cat) el.textContent = CATEGORY_MAP[cat] || '';
}

// â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitManual() {
  const ts = new Date().toISOString();
  let rows = [], d = {};

  if (currentMode === 'transfer') {
    const amount = getRawAmt('m-amount');
    const date   = document.getElementById('m-date').value;
    const from   = document.getElementById('m-from')?.value || PAYMENT_METHODS[0];
    const to     = document.getElementById('m-to')?.value   || PAYMENT_METHODS[1];
    const memo   = document.getElementById('m-memo').value;
    if (!amount || !date)  { alert('Amount and date are required.'); return; }
    if (from === to)       { alert('From and To accounts must be different.'); return; }
    const sd = toSheetDate(date);
    rows = [
      [ts, 'Transfer', -amount, sd, `To ${to}`,    from, '', '', memo, 'Myself'],
      [ts, 'Transfer',  amount, sd, `From ${from}`, to,  '', '', memo, 'Myself'],
    ];
    d = { type: 'Transfer', amount, category: '', paymentMethod: from };
    localStorage.setItem('lastPaymentMethod', from);

  } else {
    const type     = document.getElementById('m-type')?.value || 'Expense';
    const amount   = getRawAmt('m-amount');
    const date     = document.getElementById('m-date')?.value    || todayISO();
    const merchant = document.getElementById('m-merchant')?.value || '';
    const payment  = document.getElementById('m-payment')?.value  || PAYMENT_METHODS[0];
    const memo     = document.getElementById('m-memo')?.value     || '';
    if (!amount || !date) { alert('Amount and date are required.'); return; }
    const sd = toSheetDate(date);

    if (type === 'Balance') {
      rows = [[ts, 'Balance', Math.abs(amount), sd, `${payment} Balance`, payment, '', '', memo, '']];
      d    = { type: 'Balance', amount, paymentMethod: payment, merchant: `${payment} Balance` };
    } else {
      const category = document.getElementById('m-category-display')?.dataset.val || EXPENSE_CATS[0];
      const review   = getReviewVal();
      const amt      = type === 'Income' ? Math.abs(amount) : -Math.abs(amount);
      const group    = CATEGORY_MAP[category] || '';
      rows = [[ts, type, amt, sd, merchant, payment, category, group, memo, review]];
      d    = { type, amount, category, group, paymentMethod: payment, merchant };
    }
    localStorage.setItem('lastPaymentMethod', payment);
  }

  haptic('medium');
  await appendRows(rows, d);
}

// â”€â”€ APPEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function appendRows(rows, d) {
  lastFailedRows = rows;
  try {
    const fd = new FormData();
    fd.append('data', JSON.stringify({ rows }));
    await fetch(WEBHOOK, { method: 'POST', body: fd });

    if (d && d.amount && d.merchant) {
      lastLoggedKey  = `${d.amount}|${d.merchant}`;
      lastLoggedTime = Date.now();
    }
    lastFailedRows = null;

    document.getElementById('success-label').textContent =
      rows.length > 1 ? 'Transfer logged' : `${d?.type || 'Transaction'} logged`;

    const det = document.getElementById('success-detail');
    if (d && rows.length === 1) {
      det.innerHTML = `
        <div class="success-row">${fmt(Math.abs(rows[0][2]))}</div>
        <div class="success-row"><strong>${d.merchant || d.type}</strong> Â· ${d.paymentMethod}</div>
        ${d.category ? `<div class="success-row">${d.category} <span style="color:var(--muted)">â†’</span> ${d.group || ''}</div>` : ''}`;
    } else if (rows.length > 1) {
      det.innerHTML = `<div class="success-row">${fmt(Math.abs(rows[0][2]))} moved</div>`;
    }

    show('screen-success');
    haptic('success');
    setTimeout(cancelConfirm, 2400);

  } catch(err) {
    console.error(err);
    haptic('error');
    show('screen-failure');
  }
}

function retryLog()   { if (lastFailedRows) appendRows(lastFailedRows, parsedData); }
function copyFailed() {
  if (!lastFailedRows) return;
  navigator.clipboard.writeText(lastFailedRows.map(r => r.join('\t')).join('\n'))
    .then(() => alert('Row copied to clipboard.'));
}

// â”€â”€ GENERIC PICKER SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openPicker(targetId, options, current, cb) {
  _pickerTarget  = targetId;
  _pickerOptions = options || [];
  _pickerCb      = cb || null;
  const cur = current || document.getElementById(targetId + '-display')?.dataset.val || '';

  document.getElementById('picker-list').innerHTML = _pickerOptions.map(o =>
    `<div class="picker-item ${o === cur ? 'picker-item-active' : ''}" ontouchend="selectPicker('${o}')" onclick="selectPicker('${o}')">${o}</div>`
  ).join('');
  document.getElementById('picker-sheet').style.display = 'flex';
  haptic('light');
}

function selectPicker(val) {
  const disp = document.getElementById(_pickerTarget + '-display');
  if (disp) {
    disp.dataset.val = val;
    const caret = disp.querySelector('.picker-caret');
    disp.textContent = val;
    if (caret) disp.appendChild(caret);
  }
  closePicker();
  if (_pickerCb) _pickerCb();
  haptic('light');
}

function setPickerVal(id, val) {
  const disp = document.getElementById(id + '-display');
  if (disp) {
    disp.dataset.val = val;
    const caret = disp.querySelector('.picker-caret');
    disp.textContent = val;
    if (caret) disp.appendChild(caret);
  }
}

function closePicker() {
  document.getElementById('picker-sheet').style.display = 'none';
}

// â”€â”€ CATEGORY PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openCategoryPicker() {
  // FIX: reads m-type directly (was incorrectly reading m-type-display dataset)
  const type = document.getElementById('m-type')?.value || 'Expense';
  const cats = type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  const cur  = document.getElementById('m-category-display')?.dataset.val || '';

  const searchEl = document.getElementById('cat-search');
  if (searchEl) searchEl.value = '';

  document.getElementById('cat-list').innerHTML = renderCatList(cats, cur);
  document.getElementById('cat-sheet').style.display = 'flex';
  haptic('light');
}

function renderCatList(cats, cur) {
  const groups = {};
  cats.forEach(c => {
    const g = CATEGORY_MAP[c] || 'Other';
    if (!groups[g]) groups[g] = [];
    groups[g].push(c);
  });
  return Object.entries(groups).map(([g, cs]) =>
    `<div class="cat-group-label">${g}</div>` +
    cs.map(c =>
      `<div class="cat-item ${c === cur ? 'cat-item-active' : ''}" ontouchend="selectCategory('${c}')" onclick="selectCategory('${c}')">${c}</div>`
    ).join('')
  ).join('');
}

// FIX: reads m-type directly (was incorrectly reading m-type-display dataset)
function filterCats(val) {
  const type = document.getElementById('m-type')?.value || 'Expense';
  const cats = (type === 'Income' ? INCOME_CATS : EXPENSE_CATS).filter(c =>
    c.toLowerCase().includes(val.toLowerCase())
  );
  const cur = document.getElementById('m-category-display')?.dataset.val || '';
  document.getElementById('cat-list').innerHTML = renderCatList(cats, cur);
}

function selectCategory(val) {
  const disp = document.getElementById('m-category-display');
  if (disp) {
    disp.dataset.val = val;
    const caret = disp.querySelector('.picker-caret');
    disp.textContent = val;
    if (caret) disp.appendChild(caret);
  }
  updateManualGroup();
  closeCatPicker();
  haptic('light');
}

function closeCatPicker() {
  document.getElementById('cat-sheet').style.display = 'none';
}

// â”€â”€ NUMPAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openNumpad(targetId) {
  npTarget = targetId;
  const hidden = document.getElementById(targetId);
  npExpr = hidden?.value && hidden.value !== '0' ? hidden.value : '0';
  renderNumpad();
  document.getElementById('numpad-overlay').style.display = 'flex';
  haptic('light');
}

function renderNumpad() {
  const exprEl   = document.getElementById('np-expr');
  const resultEl = document.getElementById('np-result');
  if (!exprEl) return;
  exprEl.textContent = formatExprDisplay(npExpr);
  if (/[+\-Ã—Ã·]/.test(npExpr) && npExpr.length > 1) {
    const result = evalExpr(npExpr.replace(/Ã—/g, '*').replace(/Ã·/g, '/'));
    resultEl.textContent = result !== null ? '= ' + fmt(result) : '';
  } else {
    resultEl.textContent = '';
  }
}

function formatExprDisplay(expr) {
  return expr.replace(/[0-9]+(\.[0-9]*)*/g, seg => {
    const parts = seg.split('.');
    const int   = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.length > 1 ? int + '.' + parts[1] : int;
  });
}

function npInput(char) {
  haptic('light');
  if (npExpr === '0' && char !== '.' && !/[+\-Ã—Ã·]/.test(char)) {
    npExpr = char;
  } else {
    if (/[+\-Ã—Ã·]/.test(char) && /[+\-Ã—Ã·]/.test(npExpr.slice(-1))) {
      npExpr = npExpr.slice(0, -1) + char;
    } else {
      npExpr += char;
    }
  }
  renderNumpad();
}

function npDelete() {
  haptic('light');
  npExpr = npExpr.length > 1 ? npExpr.slice(0, -1) : '0';
  renderNumpad();
}

function npDone() {
  const raw    = npExpr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
  const result = evalExpr(raw) ?? parseFloat(raw) ?? 0;
  const final  = Math.round(result * 100) / 100;

  const hidden = document.getElementById(npTarget);
  if (hidden) hidden.value = String(final);

  const display = document.getElementById(npTarget + '-display');
  if (display) {
    display.textContent = fmt(final);
    display.style.color = 'var(--text)';
  }

  document.getElementById('numpad-overlay').style.display = 'none';
  haptic('medium');
}

function numpadOutside(e) {
  if (e.target === document.getElementById('numpad-overlay')) npDone();
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

loadSettings();
selectMode(currentMode);

</script>
</body>
</html>
