<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>YNAB</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@700&family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

:root {
  --bg: #0b0b0d;
  --surface: #141416;
  --surface2: #1e1e22;
  --surface3: #28282e;
  --border: #2a2a30;
  --border2: #363640;
  --accent: #2a9d9f;
  --accent-dim: rgba(42,157,159,0.1);
  --accent-border: rgba(42,157,159,0.3);
  --text: #ededf0;
  --text2: #9898a6;
  --muted: #60606e;
  --danger: #ff5c5c;
  --danger-dim: rgba(255,92,92,0.08);
  --danger-border: rgba(255,92,92,0.25);
  --income: #4ade80;
  --expense: #ff5c5c;
  --transfer: #b8a9e0;
  --transfer-dim: rgba(184,169,224,0.08);
  --warn: #c8922a;
  --warn-dim: rgba(200,146,42,0.08);
  --warn-border: rgba(200,146,42,0.25);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
  overflow-x: hidden;
}

.app { width: 100%; max-width: 430px; min-height: 100%; display: flex; flex-direction: column; padding-bottom: 40px; }

/* TOP BAR */
.topbar { padding: 20px 20px 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.wordmark { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
.wordmark span { color: var(--accent); }
.gear-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 16px; }
.gear-btn:hover { border-color: var(--border2); color: var(--text2); }
.gear-btn:active { transform: scale(0.92); }

/* MODE PILLS */
.mode-strip { padding: 16px 20px 0; flex-shrink: 0; }
.pills { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 3px; gap: 2px; }
.pill { flex: 1; padding: 8px 4px; border-radius: 9px; font-size: 12px; font-weight: 500; color: var(--muted); text-align: center; cursor: pointer; transition: all 0.18s; white-space: nowrap; user-select: none; }
.pill:hover { color: var(--text2); }
.pill.active { background: var(--surface3); color: var(--text); font-weight: 600; }
.pill.active[data-mode="expense"] { color: var(--expense); }
.pill.active[data-mode="income"]  { color: var(--income); }
.pill.active[data-mode="transfer"]{ color: var(--transfer); }

/* CONTENT */
.content { flex: 1; padding: 16px 20px 0; display: flex; flex-direction: column; gap: 12px; }

/* SCREENS */
.screen { display: none; flex-direction: column; gap: 12px; }
.screen.active { display: flex; animation: fadeUp 0.2s cubic-bezier(0.22,1,0.36,1); }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* UPLOAD HERO */
.upload-hero { min-height: 260px; background: var(--surface); border: 1.5px dashed var(--border2); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
.upload-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(42,157,159,0.07) 0%, transparent 70%); pointer-events: none; }
.upload-hero:hover, .upload-hero.drag { border-color: var(--accent); background: var(--accent-dim); }
.upload-hero:active { transform: scale(0.985); }
.upload-icon { width: 60px; height: 60px; border-radius: 16px; background: var(--surface2); border: 1px solid var(--border2); display: flex; align-items: center; justify-content: center; font-size: 26px; transition: transform 0.2s; }
.upload-hero:active .upload-icon { transform: scale(0.9); }
.upload-label { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 600; }
.upload-sub { font-size: 13px; color: var(--muted); }
#file-input { display: none; }

/* PARSING */
.parsing-screen { min-height: 260px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; }
.pulse-ring { width: 48px; height: 48px; position: relative; display: flex; align-items: center; justify-content: center; }
.pulse-ring::before, .pulse-ring::after { content: ''; position: absolute; border: 1.5px solid var(--accent); border-radius: 50%; animation: pulse-out 1.4s ease-out infinite; }
.pulse-ring::after { animation-delay: 0.55s; }
@keyframes pulse-out { 0% { width: 14px; height: 14px; opacity: 0.9; } 100% { width: 48px; height: 48px; opacity: 0; } }
.pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); z-index: 1; }
.parsing-text { font-size: 13px; color: var(--text2); letter-spacing: 0.01em; }

/* RECEIPT */
.receipt { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }
.receipt-hero { padding: 22px 22px 18px; border-bottom: 1px dashed var(--border2); transition: background 0.3s; }
.receipt-hero.expense-bg  { background: rgba(255,92,92,0.04); }
.receipt-hero.income-bg   { background: rgba(42,157,159,0.06); }
.receipt-hero.transfer-bg { background: rgba(155,143,255,0.04); }

.hero-amount-wrap { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
.receipt-amount { font-family: 'Space Grotesk', sans-serif; font-size: 36px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; cursor: pointer; border-bottom: 1.5px dashed transparent; transition: border-color 0.15s; flex: 1; }
.receipt-amount:hover { border-bottom-color: var(--border2); }
.receipt-amount.expense  { color: var(--expense); }
.receipt-amount.income   { color: var(--income); }
.receipt-amount.transfer { color: var(--transfer); }
.receipt-amount-input { font-family: 'Space Grotesk', sans-serif; font-size: 36px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; background: transparent; border: none; outline: none; width: 100%; }
.receipt-amount-input.expense  { color: var(--expense); }
.receipt-amount-input.income   { color: var(--income); }
.receipt-amount-input.transfer { color: var(--transfer); }

.type-chip { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; padding: 3px 7px; border-radius: 6px; font-weight: 500; margin-top: 6px; flex-shrink: 0; }
.type-chip.expense  { background: var(--danger-dim);   color: var(--expense);  border: 1px solid var(--danger-border); }
.type-chip.income   { background: var(--accent-dim);   color: var(--income);   border: 1px solid var(--accent-border); }
.type-chip.transfer { background: var(--transfer-dim); color: var(--transfer); border: 1px solid rgba(184,169,224,0.25); }

.receipt-meta { display: flex; align-items: center; gap: 10px; }
.receipt-merchant-wrap { flex: 1; }
.receipt-merchant { font-size: 15px; font-weight: 600; color: var(--text); cursor: pointer; border-bottom: 1.5px dashed transparent; display: inline-block; transition: border-color 0.15s; }
.receipt-merchant:hover { border-bottom-color: var(--border2); }
.merchant-input { font-size: 15px; font-weight: 600; background: transparent; border: none; border-bottom: 1.5px solid var(--accent-border); outline: none; color: var(--text); width: 100%; padding-bottom: 1px; }
.receipt-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); cursor: pointer; border-bottom: 1.5px dashed transparent; transition: border-color 0.15s; white-space: nowrap; }
.receipt-date:hover { border-bottom-color: var(--border2); }
.date-input { font-family: 'DM Mono', monospace; font-size: 11px; background: transparent; border: none; border-bottom: 1.5px solid var(--accent-border); outline: none; color: var(--text2); width: 120px; }

/* WARN */
.warn-banner { background: var(--warn-dim); border: 1px solid var(--warn-border); border-radius: 10px; padding: 8px 14px; font-size: 12px; color: var(--warn); display: flex; align-items: center; gap: 6px; }

/* FIELD ROWS */
.field-section { padding: 2px 0; }
.field-row { display: grid; grid-template-columns: 76px 1fr; align-items: center; padding: 10px 22px; border-bottom: 1px solid var(--border); min-height: 46px; gap: 12px; }
.field-row:last-child { border-bottom: none; }
.field-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.field-val { font-size: 14px; font-weight: 500; color: var(--text); text-align: right; }
.field-val.group-tag { display: flex; justify-content: flex-end; }
.group-badge { font-family: 'DM Mono', monospace; font-size: 10px; background: var(--surface3); border: 1px solid var(--border2); border-radius: 6px; padding: 2px 8px; color: var(--text2); letter-spacing: 0.04em; }
.auto-badge { font-family: 'DM Mono', monospace; font-size: 9px; background: var(--accent-dim); border: 1px solid var(--accent-border); border-radius: 5px; padding: 2px 6px; color: var(--accent); letter-spacing: 0.04em; margin-left: 6px; }

.inline-input { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; }
.inline-input::placeholder { color: var(--muted); }
.char-count { font-size: 10px; color: var(--muted); text-align: right; margin-top: 2px; font-family: 'DM Mono', monospace; }

/* SEARCHABLE DROPDOWN */
.dropdown-wrap { position: relative; width: 100%; display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
.dropdown-input { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; cursor: pointer; }
.dropdown-input::placeholder { color: var(--muted); }
.dropdown-list { position: absolute; right: 0; top: calc(100% + 6px); background: var(--surface2); border: 1px solid var(--border2); border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 50; min-width: 180px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: dropIn 0.15s cubic-bezier(0.22,1,0.36,1); }
@keyframes dropIn { from { opacity: 0; transform: translateY(-4px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
.dropdown-item { padding: 10px 14px; font-size: 13px; cursor: pointer; color: var(--text); transition: background 0.1s; }
.dropdown-item:hover, .dropdown-item.highlighted { background: var(--surface3); }
.dropdown-item.selected { color: var(--accent); }
.dropdown-empty { padding: 10px 14px; font-size: 12px; color: var(--muted); text-align: center; }

/* NATIVE SELECT */
.inline-select { background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; padding: 6px 10px; outline: none; text-align: right; }

/* DUPE WARNING */
.dupe-card { background: var(--warn-dim); border: 1px solid var(--warn-border); border-radius: 14px; padding: 14px 18px; display: flex; flex-direction: column; gap: 10px; }
.dupe-title { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; color: var(--warn); }
.dupe-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }
.dupe-actions { display: flex; gap: 8px; }
.btn-dupe-log { flex: 1; padding: 10px; border-radius: 10px; background: var(--warn); color: #061414; font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; border: none; cursor: pointer; }
.btn-dupe-cancel { flex: 1; padding: 10px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; }

/* ACTIONS */
.action-bar { display: flex; gap: 10px; }
.btn { flex: 1; padding: 16px; border-radius: 14px; font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; letter-spacing: -0.01em; position: relative; overflow: hidden; }
.btn::after { content: ''; position: absolute; inset: 0; background: white; opacity: 0; transition: opacity 0.15s; border-radius: inherit; }
.btn:active::after { opacity: 0.08; }
.btn-log { background: var(--accent); color: #051010; }
.btn-log:hover { filter: brightness(1.08); }
.btn-log:active { transform: scale(0.96); }
.btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text2); }
.btn-ghost:hover { border-color: var(--border2); color: var(--text); }
.btn-ghost:active { transform: scale(0.97); }

/* FAILURE */
.failure-card { background: var(--danger-dim); border: 1px solid var(--danger-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.failure-title { font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; color: var(--danger); }
.failure-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }
.failure-actions { display: flex; gap: 8px; }
.btn-retry { flex: 1; padding: 12px; border-radius: 10px; background: var(--danger); color: #fff; font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; }
.btn-copy  { flex: 1; padding: 12px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-retry:active, .btn-copy:active { transform: scale(0.96); }

/* SUCCESS */
.success-card { background: var(--accent-dim); border: 1px solid var(--accent-border); border-radius: 20px; padding: 32px 20px; display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; animation: successPop 0.35s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes successPop { from { opacity: 0; transform: scale(0.88); } to { opacity: 1; transform: scale(1); } }
.success-check { width: 52px; height: 52px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 22px; color: #061414; margin-bottom: 4px; animation: checkPop 0.4s 0.1s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes checkPop { from { transform: scale(0); } to { transform: scale(1); } }
.success-label { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent); }
.success-detail { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
.success-row { font-size: 13px; color: var(--text2); }
.success-row strong { color: var(--text); font-weight: 600; }

/* MANUAL FORM */
.form-block { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
.form-row-inner { display: flex; align-items: center; padding: 12px 22px; border-bottom: 1px solid var(--border); min-height: 48px; gap: 12px; }
.form-row-inner:last-child { border-bottom: none; }
.form-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); flex-shrink: 0; width: 76px; }
.form-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; flex: 1; min-width: 0; }
.form-ctrl::placeholder { color: var(--muted); }
.form-select-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text); text-align: right; width: 100%; cursor: pointer; }

.transfer-notice { background: var(--transfer-dim); border: 1px solid rgba(184,169,224,0.2); border-radius: 12px; padding: 10px 14px; font-size: 12px; color: var(--transfer); }

/* NUMPAD */
.numpad-overlay { position: fixed; inset: 0; z-index: 200; display: flex; align-items: flex-end; justify-content: center; }
.numpad { width: 100%; max-width: 430px; background: var(--surface); border-top: 1px solid var(--border2); padding: 12px 16px 40px; animation: slideUp 0.22s cubic-bezier(0.22,1,0.36,1); }
.numpad-display { background: var(--bg); border: 1px solid var(--border2); border-radius: 12px; padding: 14px 18px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; min-height: 56px; }
.numpad-expr { font-family: 'DM Mono', monospace; font-size: 22px; color: var(--text); flex: 1; word-break: break-all; }
.numpad-result { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--accent); margin-left: 10px; white-space: nowrap; }
.numpad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.nk { height: 52px; border-radius: 12px; border: none; font-family: 'DM Mono', monospace; font-size: 18px; font-weight: 500; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
.nk:active { transform: scale(0.92); }
.nk-num  { background: var(--surface2); color: var(--text); }
.nk-num:active  { background: var(--surface3); }
.nk-op   { background: var(--surface3); color: var(--accent); font-size: 20px; }
.nk-op:active   { background: var(--border2); }
.nk-del  { background: var(--surface3); color: var(--text2); font-size: 15px; }
.nk-done { background: var(--accent); color: #051010; font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 700; }
.nk-done:active { filter: brightness(1.1); }
.nk-zero { grid-column: span 2; }

/* REVIEW BUTTONS */
.review-btns { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
.review-btn { padding: 5px 12px; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; border: 1px solid var(--border2); background: transparent; color: var(--text2); cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.review-btn:hover { border-color: var(--accent); color: var(--accent); }
.review-btn.active { background: var(--accent); border-color: var(--accent); color: #051010; font-weight: 600; }

/* SETTINGS */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
.overlay.open { display: flex; }
.sheet { width: 100%; max-width: 430px; background: var(--surface); border-radius: 24px 24px 0 0; border: 1px solid var(--border); border-bottom: none; padding: 12px 20px 52px; display: flex; flex-direction: column; gap: 14px; animation: slideUp 0.25s cubic-bezier(0.22,1,0.36,1); }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 4px; }
.sheet-title { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; }
.setting-group { display: flex; flex-direction: column; gap: 6px; }
.setting-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.setting-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 12px 14px; outline: none; transition: border-color 0.15s; width: 100%; }
.setting-input:focus { border-color: var(--accent-border); }
.setting-hint { font-size: 11px; color: var(--muted); line-height: 1.6; }
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="wordmark">YNA<span>B</span></div>
    <div class="gear-btn" onclick="openSettings()">âš™</div>
  </div>

  <div class="mode-strip">
    <div class="pills">
      <div class="pill active" data-mode="expense"  onclick="selectMode('expense')">Expense</div>
      <div class="pill"        data-mode="income"   onclick="selectMode('income')">Income</div>
      <div class="pill"        data-mode="transfer" onclick="selectMode('transfer')">Transfer</div>
      <div class="pill"        data-mode="manual"   onclick="selectMode('manual')">Manual</div>
    </div>
  </div>

  <div class="content">
    <!-- UPLOAD -->
    <div class="screen active" id="screen-upload">
      <div class="upload-hero" id="upload-hero" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon" id="upload-icon">ðŸ“·</div>
        <div class="upload-label" id="upload-label">Share a screenshot</div>
        <div class="upload-sub"   id="upload-sub">GCash, credit card, any bank app</div>
      </div>
      <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)" />
    </div>

    <!-- PARSING -->
    <div class="screen" id="screen-parsing">
      <div class="parsing-screen">
        <div class="pulse-ring"><div class="pulse-dot"></div></div>
        <div class="parsing-text">Reading screenshotâ€¦</div>
      </div>
    </div>

    <!-- CONFIRM -->
    <div class="screen" id="screen-confirm">
      <div class="receipt" id="receipt-card">
        <div class="receipt-hero" id="receipt-hero">
          <div class="hero-amount-wrap">
            <div class="receipt-amount" id="r-amount" onclick="editAmount()">â‚±0.00</div>
            <div class="type-chip" id="r-type-chip">expense</div>
          </div>
          <div class="receipt-meta">
            <div class="receipt-merchant-wrap">
              <div class="receipt-merchant" id="r-merchant" onclick="editMerchant()">â€”</div>
            </div>
            <div class="receipt-date" id="r-date" onclick="editDate()">â€”</div>
          </div>
        </div>
        <div id="warn-banner-wrap"></div>
        <div class="field-section" id="r-fields"></div>
      </div>

      <div id="dupe-warn-wrap"></div>
      <div id="transfer-notice" class="transfer-notice" style="display:none">â†• Logs 2 rows. Outgoing and incoming.</div>

      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Retake</div>
        <div class="btn btn-log" onclick="handleLogIt()">Log It</div>
      </div>
    </div>

    <!-- FAILURE -->
    <div class="screen" id="screen-failure">
      <div class="failure-card">
        <div class="failure-title">Failed to log</div>
        <div class="failure-desc">Transaction did not reach your Sheet. Retry, or copy the rows.</div>
        <div class="failure-actions">
          <button class="btn-retry" onclick="retryLog()">Retry</button>
          <button class="btn-copy"  onclick="copyFailed()">Copy row</button>
        </div>
      </div>
      <div class="btn btn-ghost" onclick="cancelConfirm()">Start over</div>
    </div>

    <!-- SUCCESS -->
    <div class="screen" id="screen-success">
      <div class="success-card">
        <div class="success-check">âœ“</div>
        <div class="success-label" id="success-label">Logged</div>
        <div class="success-detail" id="success-detail"></div>
      </div>
    </div>

    <!-- MANUAL -->
    <div class="screen" id="screen-manual">
      <div class="form-block" id="manual-form"></div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Cancel</div>
        <div class="btn btn-log" onclick="submitManual()">Log It</div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="overlay" onclick="closeSettings(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Settings</div>

    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input class="setting-input" type="password" id="s-gemini" placeholder="AIzaâ€¦" oninput="saveSetting('gemini',this.value)" />
      <div class="setting-hint">This runs in the browser. Use key restrictions.</div>
    </div>

    <div class="setting-group">
      <div class="setting-label">Webhook URL</div>
      <input class="setting-input" type="text" id="s-webhook" placeholder="https://script.google.com/macros/s/.../exec" oninput="saveSetting('webhook',this.value)" />
      <div class="setting-hint">Your Apps Script /exec endpoint.</div>
    </div>

    <div class="btn btn-log" onclick="closeSettings()">Done</div>
  </div>
</div>

<!-- CATEGORY PICKER SHEET -->
<div class="sheet-overlay" id="cat-sheet" style="display:none;position:fixed;inset:0;z-index:300;align-items:flex-end;justify-content:center;background:rgba(0,0,0,0.6)" onclick="if(event.target===this)closeCatPicker()">
  <div style="width:100%;max-width:430px;background:var(--surface);border-radius:24px 24px 0 0;border:1px solid var(--border2);border-bottom:none;padding:8px 0 48px;max-height:70vh;display:flex;flex-direction:column;animation:slideUp 0.22s cubic-bezier(0.22,1,0.36,1)">
    <div style="width:36px;height:4px;background:var(--border2);border-radius:2px;margin:8px auto 12px"></div>
    <div style="padding:0 16px 10px">
      <input id="cat-search" type="text" placeholder="Searchâ€¦" autocomplete="off"
        style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none"
        oninput="filterCats(this.value)" />
    </div>
    <div id="cat-list" style="overflow-y:auto;padding:0 8px 8px"></div>
  </div>
</div>

<!-- NUMPAD -->
<div class="numpad-overlay" id="numpad-overlay" style="display:none" onclick="numpadOutside(event)">
  <div class="numpad">
    <div class="numpad-display">
      <div class="numpad-expr" id="np-expr">0</div>
      <div class="numpad-result" id="np-result"></div>
    </div>
    <div class="numpad-grid">
      <button class="nk nk-num" onclick="npInput('7')">7</button>
      <button class="nk nk-num" onclick="npInput('8')">8</button>
      <button class="nk nk-num" onclick="npInput('9')">9</button>
      <button class="nk nk-op"  onclick="npInput('Ã·')">Ã·</button>

      <button class="nk nk-num" onclick="npInput('4')">4</button>
      <button class="nk nk-num" onclick="npInput('5')">5</button>
      <button class="nk nk-num" onclick="npInput('6')">6</button>
      <button class="nk nk-op"  onclick="npInput('Ã—')">Ã—</button>

      <button class="nk nk-num" onclick="npInput('1')">1</button>
      <button class="nk nk-num" onclick="npInput('2')">2</button>
      <button class="nk nk-num" onclick="npInput('3')">3</button>
      <button class="nk nk-op"  onclick="npInput('-')">âˆ’</button>

      <button class="nk nk-num nk-zero" onclick="npInput('0')">0</button>
      <button class="nk nk-num" onclick="npInput('.')">.</button>
      <button class="nk nk-op"  onclick="npInput('+')">+</button>

      <button class="nk nk-del" style="grid-column:span 3" onclick="npDelete()">âŒ« delete</button>
      <button class="nk nk-done" onclick="npDone()">Done</button>
    </div>
  </div>
</div>

<script>
/* CONFIG */
const WEBHOOK_DEFAULT = 'https://script.google.com/macros/s/AKfycbwfl8-4sVKehGHxjGJirXVOYoTOZyinPFijxhQxJVVZQbWFaeBv53hr5HHuoPzYCg5z-Q/exec';

/* DATA */
const CATEGORY_MAP = {
  'Salary':'Income','IOU':'Income',
  'Electricity':'Home','Groceries':'Home','Lulay':'Home',
  'Pet Food':'Pets','Grooming':'Pets','Litter':'Pets','Misc':'Pets','Vet':'Pets',
  'Doctor':'Health','Supplements':'Health','Therapy':'Health','Medicine':'Health','Lab Tests':'Health','Eyes':'Health',
  'Cellphone':'Quality Of Life','Eating Out':'Quality Of Life','Car':'Quality Of Life','Self Care':'Quality Of Life',
  'Social':'Quality Of Life','Shopping':'Quality Of Life','Transpo':'Quality Of Life','Others':'Quality Of Life',
  'Stellar Rebels':'Stellar Rebels',
  'Digital Subscriptions':'Sinking','Gifts':'Sinking','Car Maintenance':'Sinking','Home Maintenance':'Sinking',
  'Family Emergency':'Emergency','Medical Emergency':'Emergency','Pet Emergency':'Emergency','Job Loss':'Emergency',
  'Tech Fund':'Goals','Beauty Fund':'Goals','Vacation Fund':'Goals',
};

const INCOME_CATS     = ['Salary','IOU'];
const EXPENSE_CATS    = Object.keys(CATEGORY_MAP).filter(c => !INCOME_CATS.includes(c));
const PAYMENT_METHODS = ['GCash','Maribank','BDO','BPI','Maya','UnionBank','UnionBank Credit','Cash'];
const REVIEW_OPTIONS  = ['Myself','Others','Both'];

const MERCHANT_RULES = [
  { keywords: ['grab'],                     paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['indrive','in drive'],       paymentMethod: 'Cash',             category: null },
  { keywords: ['shopee'],                   paymentMethod: 'Maribank',         category: null },
  { keywords: ['lazada'],                   paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['app store','apple'],        paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['google play','play store'], paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['netflix'],                  paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['spotify'],                  paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['youtube premium'],          paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['canva'],                    paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['adobe'],                    paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
];

/* STATE */
let currentMode     = localStorage.getItem('lastMode') || 'expense';
let manualMode      = 'manual'; // 'manual' or 'transfer'
let parsedData      = {};
let lastFailedRows  = null;
let lastLoggedKey   = null;
let lastLoggedTime  = 0;
let pendingRows     = null;

/* SETTINGS */
function loadSettings() {
  document.getElementById('s-gemini').value  = localStorage.getItem('gemini')  || '';
  document.getElementById('s-webhook').value = localStorage.getItem('webhook') || WEBHOOK_DEFAULT;
}
function saveSetting(k,v) { localStorage.setItem(k,v); }
function openSettings()   { loadSettings(); document.getElementById('overlay').classList.add('open'); }
function closeSettings(e) {
  if (!e || e.target === document.getElementById('overlay')) document.getElementById('overlay').classList.remove('open');
}
function getWebhook() {
  return (localStorage.getItem('webhook') || WEBHOOK_DEFAULT).trim();
}

/* UTIL */
function haptic(style='light') {
  if (!navigator.vibrate) return;
  const map = { light:30, medium:60, success:[30,50,30], error:[60,30,60] };
  navigator.vibrate(map[style] || 30);
}
function fmt(n) {
  return 'â‚±' + Number(n).toLocaleString('en-PH', { minimumFractionDigits:2, maximumFractionDigits:2 });
}
function toSheetDate(isoOrRaw) {
  const d = new Date(isoOrRaw + 'T00:00:00');
  if (isNaN(d)) return isoOrRaw;
  return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
}
function todayISO() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function displayDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  if (isNaN(d)) return iso;
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}
function applyMerchantRules(merchant) {
  if (!merchant) return {};
  const lower = merchant.toLowerCase();
  for (const rule of MERCHANT_RULES) {
    if (rule.keywords.some(k => lower.includes(k))) {
      return { paymentMethod: rule.paymentMethod, category: rule.category };
    }
  }
  return {};
}
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  closeAllDropdowns();
}
function cancelConfirm() {
  parsedData = {};
  lastFailedRows = null;
  pendingRows = null;
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  refreshHero();
  show('screen-upload');
}

/* MODE */
function selectMode(mode) {
  currentMode = mode;
  localStorage.setItem('lastMode', mode);

  document.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p.dataset.mode === mode));

  if (mode === 'transfer') {
    manualMode = 'transfer';
    buildManualForm('transfer');
    show('screen-manual');
    return;
  }
  if (mode === 'manual') {
    manualMode = 'manual';
    buildManualForm('manual');
    show('screen-manual');
    return;
  }

  refreshHero();
  show('screen-upload');
}
function refreshHero() {
  const map = {
    expense: { icon:'ðŸ“·', label:'Share a screenshot', sub:'GCash, credit card, any bank app' },
    income:  { icon:'ðŸ“¥', label:'Share a screenshot', sub:'Salary slip, GCash, any inflow' },
  };
  const d = map[currentMode] || map.expense;
  document.getElementById('upload-icon').textContent  = d.icon;
  document.getElementById('upload-label').textContent = d.label;
  document.getElementById('upload-sub').textContent   = d.sub;
}

/* FILE */
function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = () => parseWithGemini(reader.result);
  reader.readAsDataURL(file);
}

/* GEMINI */
async function parseWithGemini(dataUrl) {
  const rawKey = (localStorage.getItem('gemini') || '').trim();
  const apiKey = rawKey.replace(/[^A-Za-z0-9_\-]/g, '');
  if (!apiKey || apiKey.length < 20) {
    alert('Gemini API key is missing. Open Settings.');
    return;
  }

  show('screen-parsing');

  const cats  = (currentMode === 'income' ? INCOME_CATS : EXPENSE_CATS);
  const today = todayISO();

  const prompt = `Extract transaction data from this Filipino payment app screenshot.
Return ONLY JSON.

Schema:
amount: number (always positive)
date: "YYYY-MM-DD" (use ${today} if unclear)
merchant: string
payment_method: one of: ${PAYMENT_METHODS.join(', ')}
category: one of: ${cats.join(', ')}
low_confidence: boolean
If no recognizable transaction: {"error":"no_transaction"}`;

  const base64   = dataUrl.split(',')[1];
  const mimeType = dataUrl.split(';')[0].split(':')[1];

  let rawText = '';
  try {
    const schema = {
      type: "object",
      properties: {
        amount: { type: "number" },
        date: { type: "string" },
        merchant: { type: "string" },
        payment_method: { type: "string", enum: PAYMENT_METHODS },
        category: { type: "string", enum: cats },
        low_confidence: { type: "boolean" },
        error: { type: "string" }
      },
      required: ["low_confidence"],
      additionalProperties: false
    };

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inline_data: { mime_type: mimeType, data: base64 } }
          ]
        }],
        generationConfig: {
          maxOutputTokens: 400,
          temperature: 0.1,
          responseMimeType: "application/json",
          responseSchema: schema
        }
      })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error('Gemini HTTP', res.status, data);
      alert(`Gemini error ${res.status}: ${data?.error?.message || 'unknown'}`);
      show('screen-upload');
      return;
    }

    rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    if (!rawText) {
      console.error('Gemini empty response', data);
      alert('Gemini returned an empty response. Try again.');
      show('screen-upload');
      return;
    }

    const parsed = JSON.parse(rawText.trim());

    if (parsed.error === 'no_transaction') {
      alert('No transaction found. Try another screenshot or use Manual.');
      show('screen-upload');
      return;
    }

    const rules = applyMerchantRules(parsed.merchant || '');
    const paymentMethod = rules.paymentMethod || parsed.payment_method || 'GCash';
    const category      = rules.category || parsed.category || cats[0];

    parsedData = {
      type:          currentMode === 'income' ? 'Income' : 'Expense',
      amount:        Number(parsed.amount) || 0,
      date:          parsed.date || today,
      merchant:      (parsed.merchant || '').trim(),
      paymentMethod,
      category,
      group:         CATEGORY_MAP[category] || '',
      memo:          '',
      review:        'Myself',
      lowConfidence: !!parsed.low_confidence,
      autoPayment:   !!rules.paymentMethod,
      autoCategory:  !!rules.category,
    };

    buildReceiptCard();
    show('screen-confirm');
    haptic('light');
  } catch (err) {
    console.error('PARSE ERROR', err);
    if (rawText) console.error('RAW MODEL TEXT', rawText);
    alert('Could not parse screenshot. Open DevTools Console for the exact error.');
    show('screen-upload');
  }
}

/* RECEIPT */
function buildReceiptCard() {
  const d = parsedData;

  const amtEl = document.getElementById('r-amount');
  amtEl.textContent = fmt(d.amount);
  amtEl.className   = `receipt-amount ${d.type.toLowerCase()}`;

  const hero = document.getElementById('receipt-hero');
  hero.className = `receipt-hero ${d.type.toLowerCase()}-bg`;

  const chip = document.getElementById('r-type-chip');
  chip.textContent = d.type.toLowerCase();
  chip.className   = `type-chip ${d.type.toLowerCase()}`;

  document.getElementById('r-merchant').textContent = d.merchant || 'â€”';
  document.getElementById('r-date').textContent     = displayDate(d.date);

  const warnWrap = document.getElementById('warn-banner-wrap');
  warnWrap.innerHTML = d.lowConfidence
    ? `<div class="warn-banner" style="margin:0;border-radius:0;border-left:none;border-right:none;border-top:none;">âš  Low confidence. Review fields.</div>`
    : '';

  const cats = (d.type === 'Income' ? INCOME_CATS : EXPENSE_CATS);
  const fields = [
    { key:'Via',      dataKey:'paymentMethod', type:'select',   options:PAYMENT_METHODS, auto: d.autoPayment },
    { key:'Category', dataKey:'category',      type:'dropdown', options:cats,             auto: d.autoCategory },
    { key:'Group',    dataKey:'group',         type:'badge' },
    { key:'Memo',     dataKey:'memo',          type:'text' },
    { key:'Review',   dataKey:'review',        type:'select',   options:REVIEW_OPTIONS },
  ];

  const container = document.getElementById('r-fields');
  container.innerHTML = '';

  fields.forEach(f => {
    const row = document.createElement('div');
    row.className = 'field-row';
    row.dataset.key = f.dataKey;

    if (f.type === 'badge') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="field-val group-tag"><span class="group-badge" id="badge-group">${d[f.dataKey] || 'â€”'}</span></div>`;
    }

    if (f.type === 'text') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;flex:1">
          <input class="inline-input" id="field-memo" maxlength="60" value="${escapeHtml(d[f.dataKey] || '')}" placeholder="Optional"
            oninput="updateField('${f.dataKey}',this.value);updateCharCount(this)"
            onfocus="updateCharCount(this)" />
          <div class="char-count" id="memo-count" style="display:none"></div>
        </div>`;
    }

    if (f.type === 'dropdown') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="dropdown-wrap" id="dd-wrap-${f.dataKey}">
          <input class="dropdown-input" id="dd-${f.dataKey}" value="${escapeHtml(d[f.dataKey] || '')}" placeholder="Tap to searchâ€¦"
            autocomplete="off"
            onfocus="openDropdown('${f.dataKey}')"
            oninput="filterDropdown('${f.dataKey}', this.value)"
            onkeydown="dropdownKeyNav(event,'${f.dataKey}')"
            onblur="setTimeout(()=>closeAllDropdowns(),200)" />
          ${autoBadge}
          <div class="dropdown-list" id="ddlist-${f.dataKey}" style="display:none"></div>
        </div>`;
    }

    if (f.type === 'select') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      const opts = f.options.map(o => `<option ${d[f.dataKey] === o ? 'selected' : ''}>${o}</option>`).join('');
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;flex:1">
          ${autoBadge}
          <select class="inline-select" onchange="updateField('${f.dataKey}',this.value)">${opts}</select>
        </div>`;
    }

    container.appendChild(row);
  });

  renderDropdownList('category', cats, d.category);
}
function escapeHtml(s) {
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

/* HERO INLINE EDITING */
function editAmount() {
  const el = document.getElementById('r-amount');
  const raw = parsedData.amount || 0;
  el.outerHTML = `<input class="receipt-amount-input ${parsedData.type.toLowerCase()}" id="r-amount-input"
    type="text" inputmode="decimal" value="${raw}"
    onblur="commitAmount(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()" />`;
  setTimeout(() => {
    const inp = document.getElementById('r-amount-input');
    if (inp) { inp.focus(); inp.select(); }
  }, 50);
}
function commitAmount(val) {
  const num = parseFloat(String(val).replace(/,/g,'')) || 0;
  parsedData.amount = num;
  const wrap = document.getElementById('r-amount-input') || document.querySelector('.receipt-amount-input');
  if (!wrap) return;
  const div = document.createElement('div');
  div.className = `receipt-amount ${parsedData.type.toLowerCase()}`;
  div.id = 'r-amount';
  div.textContent = fmt(num);
  div.onclick = editAmount;
  wrap.replaceWith(div);
}
function editMerchant() {
  const el = document.getElementById('r-merchant');
  el.outerHTML = `<input class="merchant-input" id="merchant-input" value="${escapeHtml(parsedData.merchant || '')}"
    onblur="commitMerchant(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()" />`;
  setTimeout(() => {
    const inp = document.getElementById('merchant-input');
    if (inp) { inp.focus(); inp.select(); }
  }, 50);
}
function commitMerchant(val) {
  parsedData.merchant = val;
  const inp = document.getElementById('merchant-input');
  if (inp) {
    const div = document.createElement('div');
    div.className = 'receipt-merchant';
    div.id = 'r-merchant';
    div.textContent = val || 'â€”';
    div.onclick = editMerchant;
    inp.replaceWith(div);
  }

  const rules = applyMerchantRules(val || '');
  if (rules.paymentMethod) {
    parsedData.paymentMethod = rules.paymentMethod;
    parsedData.autoPayment = true;
    const sel = document.querySelector('[data-key="paymentMethod"] select');
    if (sel) sel.value = rules.paymentMethod;
  }
  if (rules.category) {
    parsedData.category = rules.category;
    parsedData.group = CATEGORY_MAP[rules.category] || '';
    const inpCat = document.getElementById('dd-category');
    if (inpCat) inpCat.value = rules.category;
    const badge = document.getElementById('badge-group');
    if (badge) badge.textContent = parsedData.group || 'â€”';
    renderDropdownList('category', (parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS), parsedData.category);
  }
}
function editDate() {
  const el = document.getElementById('r-date');
  el.outerHTML = `<input class="date-input" id="date-input" type="date" value="${parsedData.date || todayISO()}"
    onblur="commitDate(this.value)"
    onchange="commitDate(this.value)" />`;
  setTimeout(() => {
    const inp = document.getElementById('date-input');
    if (inp) inp.focus();
  }, 50);
}
function commitDate(val) {
  parsedData.date = val;
  const inp = document.getElementById('date-input');
  if (!inp) return;
  const div = document.createElement('div');
  div.className = 'receipt-date';
  div.id = 'r-date';
  div.textContent = displayDate(val);
  div.onclick = editDate;
  inp.replaceWith(div);
}

/* DROPDOWN */
function renderDropdownList(key, options, selected, filter='') {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list) return;

  const filtered = filter
    ? options.filter(o => o.toLowerCase().includes(filter.toLowerCase()))
    : options;

  if (!filtered.length) {
    list.innerHTML = `<div class="dropdown-empty">No match</div>`;
    list.style.display = 'block';
    return;
  }

  list.innerHTML = filtered.map(o =>
    `<div class="dropdown-item ${o === selected ? 'selected' : ''}" data-val="${escapeHtml(o)}"
      onmousedown="selectDropdownItem('${key}', this.dataset.val)" ontouchend="selectDropdownItem('${key}', this.dataset.val)">${escapeHtml(o)}</div>`
  ).join('');
  list.style.display = 'block';
}
function openDropdown(key) {
  const opts = (parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS);
  renderDropdownList(key, opts, parsedData[key] || '');
}
function filterDropdown(key, val) {
  const opts = (parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS);
  renderDropdownList(key, opts, parsedData[key] || '', val);
}
function selectDropdownItem(key, val) {
  updateField(key, val);
  const inp = document.getElementById(`dd-${key}`);
  if (inp) { inp.value = val; inp.blur(); }
  const list = document.getElementById(`ddlist-${key}`);
  if (list) list.style.display = 'none';
  haptic('light');
}
function dropdownKeyNav(e, key) {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list || list.style.display === 'none') return;
  const items = Array.from(list.querySelectorAll('.dropdown-item'));
  const current = list.querySelector('.highlighted');
  let idx = current ? items.indexOf(current) : -1;

  if (e.key === 'ArrowDown') { e.preventDefault(); idx = Math.min(idx + 1, items.length - 1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); idx = Math.max(idx - 1, 0); }
  else if (e.key === 'Enter' && current) { e.preventDefault(); selectDropdownItem(key, current.dataset.val); return; }
  else if (e.key === 'Escape') { list.style.display = 'none'; return; }

  items.forEach(it => it.classList.remove('highlighted'));
  if (items[idx]) items[idx].classList.add('highlighted');
}
function closeAllDropdowns() {
  document.querySelectorAll('.dropdown-list').forEach(l => l.style.display = 'none');
}
document.addEventListener('click', e => {
  if (!e.target.closest('.dropdown-wrap')) closeAllDropdowns();
});

/* FIELD UPDATES */
function updateField(key, value) {
  parsedData[key] = value;
  if (key === 'category') {
    parsedData.group = CATEGORY_MAP[value] || '';
    const b = document.getElementById('badge-group');
    if (b) b.textContent = parsedData.group || 'â€”';
  }
}
function updateCharCount(inp) {
  const counter = document.getElementById('memo-count');
  if (!counter) return;
  const len = inp.value.length;
  counter.style.display = len > 0 ? 'block' : 'none';
  counter.textContent = `${len}/60`;
  counter.style.color = len > 50 ? 'var(--warn)' : 'var(--muted)';
}

/* LOG IT */
function handleLogIt() {
  const amtInp = document.getElementById('r-amount-input');
  if (amtInp) commitAmount(amtInp.value);
  const mInp = document.getElementById('merchant-input');
  if (mInp) commitMerchant(mInp.value);
  const dInp = document.getElementById('date-input');
  if (dInp) commitDate(dInp.value);

  const d  = parsedData;
  const ts = new Date().toISOString();
  const amt = (d.type === 'Income') ? Math.abs(d.amount) : -Math.abs(d.amount);
  const sheetDate = toSheetDate(d.date);

  const rows = [[ts, d.type, amt, sheetDate, d.merchant, d.paymentMethod, d.category, d.group, d.memo, d.review]];

  const dupeKey = `${Math.abs(d.amount)}|${(d.merchant || '').trim().toLowerCase()}`;
  const now = Date.now();
  if (dupeKey === lastLoggedKey && now - lastLoggedTime < 60000) {
    showDupeWarning(rows, d);
    return;
  }

  haptic('medium');
  appendRows(rows, d);
}
function showDupeWarning(rows, d) {
  const wrap = document.getElementById('dupe-warn-wrap');
  wrap.innerHTML = `
    <div class="dupe-card">
      <div class="dupe-title">âš  Possible duplicate</div>
      <div class="dupe-desc">Same amount and merchant logged less than a minute ago. Log again?</div>
      <div class="dupe-actions">
        <button class="btn-dupe-log" onclick="confirmDupe()">Log anyway</button>
        <button class="btn-dupe-cancel" onclick="dismissDupe()">Cancel</button>
      </div>
    </div>`;
  pendingRows = { rows, d };
}
function confirmDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  if (pendingRows) {
    haptic('medium');
    appendRows(pendingRows.rows, pendingRows.d);
    pendingRows = null;
  }
}
function dismissDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  pendingRows = null;
}

/* MANUAL FORM */
function buildManualForm(mode) {
  const today = todayISO();
  const lastMethod = localStorage.getItem('lastPaymentMethod') || PAYMENT_METHODS[0];
  const c = document.getElementById('manual-form');

  const row = (key, ctrl) =>
    `<div class="form-row-inner"><div class="form-key">${key}</div><div style="display:flex;align-items:center;justify-content:flex-end;flex:1;min-width:0">${ctrl}</div></div>`;

  const text = (id, ph) =>
    `<input class="form-ctrl" id="${id}" type="text" placeholder="${ph}" />`;

  const nativeSelect = (id, opts, selected, onch='') =>
    `<select class="form-select-ctrl" id="${id}" ${onch}>${opts.map(o => `<option ${o===selected?'selected':''}>${o}</option>`).join('')}</select>`;

  const amtDisplay = () =>
    `<div class="form-ctrl" id="m-amount-display" onclick="openNumpad('m-amount')" style="cursor:pointer;color:var(--muted)">0.00</div><input type="hidden" id="m-amount" value="0" />`;

  const catPicker = (firstCat) =>
    `<div class="form-ctrl" id="m-category-display" data-val="${firstCat}" onclick="openCategoryPicker()" style="cursor:pointer">${firstCat}</div>`;

  if (mode === 'transfer') {
    c.innerHTML =
      row('Amount', amtDisplay()) +
      row('Date', `<input class="form-ctrl" id="m-date" type="date" value="${today}" style="color-scheme:dark" />`) +
      row('From', nativeSelect('m-from', PAYMENT_METHODS, lastMethod, 'onchange="syncTransferTo()"')) +
      row('To',   nativeSelect('m-to', PAYMENT_METHODS.filter(p => p !== lastMethod), PAYMENT_METHODS.find(p => p !== lastMethod) || PAYMENT_METHODS[1])) +
      row('Memo', text('m-memo','Optional'));
    return;
  }

  const firstCat = EXPENSE_CATS[0];
  c.innerHTML =
    row('Type', nativeSelect('m-type', ['Expense','Income','Balance'], 'Expense', 'onchange="updateManualCats()"')) +
    row('Amount', amtDisplay()) +
    row('Date', `<input class="form-ctrl" id="m-date" type="date" value="${today}" style="color-scheme:dark" />`) +
    row('Merchant', `<input class="form-ctrl" id="m-merchant" type="text" placeholder="Who or where" oninput="applyManualMerchantRules(this.value)" />`) +
    row('Via', nativeSelect('m-payment', PAYMENT_METHODS, lastMethod)) +
    row('Category', catPicker(firstCat)) +
    row('Group', `<div class="form-ctrl" id="m-group" style="color:var(--muted)">${CATEGORY_MAP[firstCat] || ''}</div>`) +
    row('Memo', text('m-memo','Optional')) +
    row('Review', `<div class="review-btns" id="review-btns">
      ${REVIEW_OPTIONS.map((o,i) => `<button type="button" class="review-btn${i===0?' active':''}" onclick="selectReview(this,'${o}')">${o}</button>`).join('')}
    </div>`);
}
function selectReview(btn, val) {
  document.querySelectorAll('.review-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function getReviewVal() {
  const active = document.querySelector('.review-btn.active');
  return active ? active.textContent : 'Myself';
}
function getRawAmt(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  return parseFloat(el.value) || 0;
}
function syncTransferTo() {
  const from  = document.getElementById('m-from')?.value;
  const toSel = document.getElementById('m-to');
  if (!toSel || !from) return;
  const filtered = PAYMENT_METHODS.filter(p => p !== from);
  toSel.innerHTML = filtered.map(p => `<option>${p}</option>`).join('');
}
function applyManualMerchantRules(val) {
  const rules = applyMerchantRules(val || '');
  if (rules.paymentMethod) {
    const sel = document.getElementById('m-payment');
    if (sel) sel.value = rules.paymentMethod;
  }
  if (rules.category) {
    setManualCategory(rules.category);
  }
}
function updateManualCats() {
  const type = document.getElementById('m-type')?.value || 'Expense';
  const catRow = document.getElementById('m-category-display')?.closest('.form-row-inner');
  const grpRow = document.getElementById('m-group')?.closest('.form-row-inner');
  const revRow = document.getElementById('review-btns')?.closest('.form-row-inner');

  if (type === 'Balance') {
    if (catRow) catRow.style.display = 'none';
    if (grpRow) grpRow.style.display = 'none';
    if (revRow) revRow.style.display = 'none';
    return;
  }

  if (catRow) catRow.style.display = '';
  if (grpRow) grpRow.style.display = '';
  if (revRow) revRow.style.display = '';

  const cats = (type === 'Income') ? INCOME_CATS : EXPENSE_CATS;
  setManualCategory(cats[0]);
}
function updateManualGroup() {
  const cat = document.getElementById('m-category-display')?.dataset.val || '';
  const el  = document.getElementById('m-group');
  if (el) el.textContent = CATEGORY_MAP[cat] || '';
}
function setManualCategory(cat) {
  const disp = document.getElementById('m-category-display');
  if (!disp) return;
  disp.dataset.val = cat;
  disp.textContent = cat;
  updateManualGroup();
}

/* SUBMIT */
async function submitManual() {
  const ts = new Date().toISOString();
  let rows = [], d = {};

  if (manualMode === 'transfer') {
    const amount = getRawAmt('m-amount');
    const date   = document.getElementById('m-date')?.value;
    const from   = document.getElementById('m-from')?.value || PAYMENT_METHODS[0];
    const to     = document.getElementById('m-to')?.value || PAYMENT_METHODS[1];
    const memo   = document.getElementById('m-memo')?.value || '';

    if (!amount || !date) { alert('Amount and date are required.'); return; }
    if (from === to) { alert('From and To must be different.'); return; }

    const sd = toSheetDate(date);
    rows = [
      [ts,'Transfer',-Math.abs(amount), sd, `To ${to}`,   from,'','',memo,'Myself'],
      [ts,'Transfer', Math.abs(amount), sd, `From ${from}`,to,'','',memo,'Myself'],
    ];
    d = { type:'Transfer', amount, merchant:`${from} â†’ ${to}`, paymentMethod:from };
    localStorage.setItem('lastPaymentMethod', from);

    haptic('medium');
    await appendRows(rows, d);
    return;
  }

  const type     = document.getElementById('m-type')?.value || 'Expense';
  const amount   = getRawAmt('m-amount');
  const date     = document.getElementById('m-date')?.value || todayISO();
  const merchant = (document.getElementById('m-merchant')?.value || '').trim();
  const payment  = document.getElementById('m-payment')?.value || PAYMENT_METHODS[0];
  const memo     = (document.getElementById('m-memo')?.value || '').trim();

  if (!amount || !date) { alert('Amount and date are required.'); return; }

  const sd = toSheetDate(date);

  if (type === 'Balance') {
    rows = [[ts, 'Balance', Math.abs(amount), sd, `${payment} Balance`, payment, '', '', memo, '' ]];
    d = { type:'Balance', amount, merchant:`${payment} Balance`, paymentMethod:payment };
    localStorage.setItem('lastPaymentMethod', payment);

    haptic('medium');
    await appendRows(rows, d);
    return;
  }

  const category = document.getElementById('m-category-display')?.dataset.val || EXPENSE_CATS[0];
  const review   = getReviewVal();
  const amt      = (type === 'Income') ? Math.abs(amount) : -Math.abs(amount);
  const group    = CATEGORY_MAP[category] || '';

  rows = [[ts, type, amt, sd, merchant || '(no merchant)', payment, category, group, memo, review]];
  d    = { type, amount, merchant: merchant || '(no merchant)', paymentMethod: payment, category, group };
  localStorage.setItem('lastPaymentMethod', payment);

  haptic('medium');
  await appendRows(rows, d);
}

/* APPEND */
async function appendRows(rows, d) {
  lastFailedRows = rows;

  try {
    const fd = new FormData();
    fd.append('data', JSON.stringify({ rows }));

    const res = await fetch(getWebhook(), { method: 'POST', body: fd });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      throw new Error(`Webhook ${res.status}: ${txt || 'unknown'}`);
    }

    if (d && d.amount && d.merchant) {
      lastLoggedKey  = `${Math.abs(d.amount)}|${String(d.merchant).trim().toLowerCase()}`;
      lastLoggedTime = Date.now();
    }

    lastFailedRows = null;

    document.getElementById('success-label').textContent =
      rows.length > 1 ? 'Transfer logged' : `${d?.type || 'Transaction'} logged`;

    const det = document.getElementById('success-detail');
    if (rows.length === 1) {
      det.innerHTML = `
        <div class="success-row">${fmt(Math.abs(rows[0][2]))}</div>
        <div class="success-row"><strong>${escapeHtml(d.merchant || d.type || 'Transaction')}</strong> Â· ${escapeHtml(d.paymentMethod || '')}</div>
        ${d.category ? `<div class="success-row">${escapeHtml(d.category)} <span style="color:var(--muted)">â†’</span> ${escapeHtml(d.group || '')}</div>` : ''}`;
    } else {
      det.innerHTML = `<div class="success-row">${fmt(Math.abs(rows[0][2]))} moved</div>`;
    }

    show('screen-success');
    haptic('success');
    setTimeout(cancelConfirm, 2400);
  } catch (err) {
    console.error('LOG ERROR', err);
    haptic('error');
    show('screen-failure');
  }
}
function retryLog() { if (lastFailedRows) appendRows(lastFailedRows, parsedData); }
function copyFailed() {
  if (!lastFailedRows) return;
  navigator.clipboard.writeText(lastFailedRows.map(r => r.join('\t')).join('\n'))
    .then(() => alert('Copied.'));
}

/* CATEGORY PICKER */
function openCategoryPicker() {
  const type = document.getElementById('m-type')?.value || 'Expense';
  const cats = (type === 'Income') ? INCOME_CATS : EXPENSE_CATS;
  const cur  = document.getElementById('m-category-display')?.dataset.val || '';

  document.getElementById('cat-search').value = '';
  document.getElementById('cat-list').innerHTML = renderCatList(cats, cur);
  document.getElementById('cat-sheet').style.display = 'flex';
  haptic('light');
}
function renderCatList(cats, cur) {
  const groups = {};
  cats.forEach(c => {
    const g = CATEGORY_MAP[c] || 'Other';
    if (!groups[g]) groups[g] = [];
    groups[g].push(c);
  });

  return Object.entries(groups).map(([g, cs]) =>
    `<div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);padding:10px 16px 4px">${escapeHtml(g)}</div>` +
    cs.map(c =>
      `<div style="padding:12px 16px;font-family:'DM Sans',sans-serif;font-size:15px;color:${c===cur?'var(--accent)':'var(--text)'};border-radius:10px;cursor:pointer"
        ontouchend="selectCategory('${escapeJs(c)}')" onclick="selectCategory('${escapeJs(c)}')">${escapeHtml(c)}</div>`
    ).join('')
  ).join('');
}
function filterCats(val) {
  const type = document.getElementById('m-type')?.value || 'Expense';
  const catsAll = (type === 'Income') ? INCOME_CATS : EXPENSE_CATS;
  const cats = catsAll.filter(c => c.toLowerCase().includes(String(val).toLowerCase()));
  const cur  = document.getElementById('m-category-display')?.dataset.val || '';
  document.getElementById('cat-list').innerHTML = renderCatList(cats, cur);
}
function selectCategory(val) {
  setManualCategory(val);
  closeCatPicker();
  haptic('light');
}
function closeCatPicker() {
  document.getElementById('cat-sheet').style.display = 'none';
}
function escapeJs(s) {
  return String(s).replaceAll('\\','\\\\').replaceAll("'","\\'");
}

/* NUMPAD */
let npTarget = null;
let npExpr = '0';

function openNumpad(targetId) {
  npTarget = targetId;
  const hidden = document.getElementById(targetId);
  npExpr = (hidden?.value && hidden.value !== '0') ? hidden.value : '0';
  renderNumpad();
  document.getElementById('numpad-overlay').style.display = 'flex';
  haptic('light');
}
function renderNumpad() {
  const exprEl = document.getElementById('np-expr');
  const resultEl = document.getElementById('np-result');
  if (!exprEl) return;

  exprEl.textContent = formatExprDisplay(npExpr);

  if (/[+\-Ã—Ã·]/.test(npExpr) && npExpr.length > 1) {
    const result = evalExpr(npExpr.replace(/Ã—/g,'*').replace(/Ã·/g,'/'));
    resultEl.textContent = (result !== null) ? '= ' + fmt(result) : '';
  } else {
    resultEl.textContent = '';
  }
}
function formatExprDisplay(expr) {
  return expr.replace(/[0-9]+(\.[0-9]*)*/g, seg => {
    const parts = seg.split('.');
    const int = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.length > 1 ? int + '.' + parts[1] : int;
  });
}
function npInput(char) {
  haptic('light');
  if (npExpr === '0' && char !== '.' && !/[+\-Ã—Ã·]/.test(char)) {
    npExpr = char;
  } else {
    if (/[+\-Ã—Ã·]/.test(char) && /[+\-Ã—Ã·]/.test(npExpr.slice(-1))) {
      npExpr = npExpr.slice(0, -1) + char;
    } else {
      npExpr += char;
    }
  }
  renderNumpad();
}
function npDelete() {
  haptic('light');
  npExpr = (npExpr.length > 1) ? npExpr.slice(0, -1) : '0';
  renderNumpad();
}
function evalExpr(str) {
  const cleaned = String(str).replace(/,/g, '').trim();
  if (!/^[0-9+\-*/.() ]+$/.test(cleaned)) return null;
  try {
    const result = Function('"use strict"; return (' + cleaned + ')')();
    if (typeof result !== 'number' || !isFinite(result)) return null;
    return Math.round(result * 100) / 100;
  } catch {
    return null;
  }
}
function npDone() {
  const raw = npExpr.replace(/Ã—/g,'*').replace(/Ã·/g,'/');
  const result = evalExpr(raw);
  const final = (result !== null) ? result : (parseFloat(raw) || 0);

  const hidden = document.getElementById(npTarget);
  if (hidden) hidden.value = String(final);

  const display = document.getElementById(npTarget + '-display');
  if (display) {
    display.textContent = fmt(final);
    display.style.color = 'var(--text)';
  }

  document.getElementById('numpad-overlay').style.display = 'none';
  haptic('medium');
}
function numpadOutside(e) {
  if (e.target === document.getElementById('numpad-overlay')) npDone();
}

/* BOOT */
loadSettings();
selectMode(currentMode);
</script>
</body>
</html>